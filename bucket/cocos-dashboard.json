{
    "version": "2.2.1",
    "homepage": "https://www.cocos.com",
    "description": "Global Leading Platform for Digital Interactive Content Development",
    "license": "Freeware",
    "architecture": {
        "64bit": {
            "url": "https://www.cocos.com/server/productionVersion/download?url=https%3A%2F%2Fdownload.cocos.com%2FCocosDashboard%2Fv2.2.1%2FCocosDashboard-v2.2.1-win-112616.exe",
            "hash": "e9e115cbbfb77408ebf1ba98bfa22496e0aa69ce07b7dd13f7f485b053c6c9e0"
        }
    },
    "installer": {
        "script": [
            "$placeholderPath = Join-Path $dir $fname",
            "$response = Get-Content $placeholderPath -Raw | ConvertFrom-Json",
            "if (-not $response.data.url) { throw 'Failed to resolve the temporary download url from Cocos API.' }",
            "$baseDownloadUrl = ($response.data.url -split '\\?')[0]",
            "if (-not $baseDownloadUrl) { throw 'Failed to derive base download url from temporary response.' }",
            "$apiEndpoint = 'https://www.cocos.com/server/productionVersion/download?url=' + [Uri]::EscapeDataString($baseDownloadUrl)",
            "$session = New-Object Microsoft.PowerShell.Commands.WebRequestSession",
            "$apiResponse = Invoke-WebRequest -Uri $apiEndpoint -WebSession $session -UseBasicParsing",
            "$apiData = $apiResponse.Content | ConvertFrom-Json",
            "if (-not $apiData.data.url) { throw 'Failed to resolve the refreshed download url from Cocos API.' }",
            "$downloadUrl = $apiData.data.url",
            "$installerName = [System.IO.Path]::GetFileName((New-Object System.Uri($downloadUrl)).AbsolutePath)",
            "if (-not $installerName) { throw 'Failed to derive installer file name from temporary download url.' }",
            "$installerPath = Join-Path $dir $installerName",
            "$headers = @{",
            "    'User-Agent' = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/129.0.0.0 Safari/537.36'",
            "    'Referer' = 'https://www.cocos.com/'",
            "    'Accept' = 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7'",
            "    'Accept-Language' = 'en-US,en;q=0.9'",
            "    'Accept-Encoding' = 'gzip, deflate, br'",
            "    'Connection' = 'keep-alive'",
            "    'Upgrade-Insecure-Requests' = '1'",
            "    'Sec-Fetch-Dest' = 'document'",
            "    'Sec-Fetch-Mode' = 'navigate'",
            "    'Sec-Fetch-Site' = 'same-site'",
            "}",
            "Remove-Item $placeholderPath -Force",
            "Invoke-WebRequest -Uri $downloadUrl -OutFile $installerPath -Headers $headers -WebSession $session",
            "Start-Process -Wait $installerPath -ArgumentList '/extract', \"`\"$dir`\"\"",
            "Expand-MsiArchive \"$dir\\CocosDashboard_setup.msi\" \"$dir\" | Out-Null",
            "Remove-Item \"$dir\\CocosDashboard_setup.aiui\" -Force -ErrorAction SilentlyContinue",
            "Remove-Item \"$dir\\CocosDashboard_setup1.cab\" -Force -ErrorAction SilentlyContinue",
            "Remove-Item \"$dir\\CocosDashboard_setup.msi\" -Force -ErrorAction SilentlyContinue",
            "Remove-Item \"$dir\\CocosDashboard-v*\" -Force -ErrorAction SilentlyContinue",
            "Remove-Item $installerPath -Force -ErrorAction SilentlyContinue"
        ]
    },
    "post_install": [
        "$config = \"$env:USERPROFILE\\.Cocos\\profiles\\editor.json\"",
        "$editors_dir = \"$persist_dir\\editors\"",
        "if (!(Test-Path $config)) {",
        "    $settings = @{",
        "        'download_url' = $editors_dir",
        "    }",
        "    New-Item $config -Type File -Force | Out-Null",
        "    Set-Content $config ($settings | ConvertToPrettyJson) -Encoding ASCII -Force",
        "} else {",
        "  $conf_content = (Get-Content $config | ConvertFrom-Json)",
        "  if ($conf_content.'download_url' -ne $editors_dir) {",
        "    $conf_content.'download_url' = $editors_dir",
        "    Set-Content $config ($conf_content | ConvertToPrettyJson) -Encoding ASCII -Force",
        "  }",
        "}"
    ],
    "persist": "editors",
    "shortcuts": [
        [
            "CocosDashboard.exe",
            "Cocos Dashboard"
        ]
    ],
    "checkver": {
        "url": "https://www.cocos.com/server/productionVersion/dashboard/latest",
        "regex": "CocosDashboard-v(?<version>[\\d.]+)-win-(?<build>\\d+)\\.exe"
    },
    "autoupdate": {
        "architecture": {
            "64bit": {
                "url": "https://www.cocos.com/server/productionVersion/download?url=https%3A%2F%2Fdownload.cocos.com%2FCocosDashboard%2Fv$matchVersion%2FCocosDashboard-v$matchVersion-win-$matchBuild.exe"
            }
        }
    }
}
